---
slug: surprise-gift-api-project-docs
title: ç›²ç›’é¡¹ç›®æ–‡æ¡£
authors: yana
tags: [surprise]
draft: true
---

# é¡¹ç›®é…ç½®

| åºå· | åŠŸèƒ½æ¨¡å—     | åŠŸèƒ½æè¿°                            | çŠ¶æ€     | å¤‡æ³¨                                     |
| ---- | ------------ | ----------------------------------- | -------- | ---------------------------------------- |
| 1    | ç¯å¢ƒé…ç½®     | ä½¿ç”¨ dotenv è¯»å–ç¯å¢ƒå˜é‡            | å·²å®Œæˆ   | å·²ç»Ÿä¸€ç®¡ç†ç¯å¢ƒå˜é‡ï¼Œæ”¯æŒ ESModule        |
| 2    | ä»£ç è§„èŒƒ     | é›†æˆ ESLint å’Œ Prettierï¼Œè‡ªåŠ¨æ ¼å¼åŒ– | å·²å®Œæˆ   | VS Code `.vscode/settings.json` é…ç½®å®Œæˆ |
| 3    | API æ¡†æ¶     | ä½¿ç”¨ Express + GraphQL æ­å»ºæ¥å£     | å·²å®Œæˆ   | æ”¯æŒ GraphiQL è°ƒè¯•                       |
| 4    | æ•°æ®åº“è¿æ¥   | ä½¿ç”¨ Mongoose è¿æ¥ MongoDB          | å·²å®Œæˆ   | æ”¯æŒè¿æ¥æ± åŠå¼‚æ­¥åˆå§‹åŒ–                   |
| 5    | ç»Ÿä¸€å“åº”æ ¼å¼ | success å’Œ fail ç»Ÿä¸€å“åº”ç»“æ„ä½“      | å·²å®Œæˆ   | æ”¯æŒçŠ¶æ€ç ã€æ¶ˆæ¯å’Œä¸šåŠ¡æ•°æ®               |
| 6    | JWT è®¤è¯     | JWT ç”Ÿæˆä¸éªŒè¯                      | å·²å®Œæˆ   | ä½¿ç”¨ç¯å¢ƒå˜é‡ç®¡ç†å¯†é’¥ï¼Œæ”¯æŒç™»å½•éªŒè¯       |
| 7    | å•†å“æ¨¡å—åŸºç¡€ | å•†å“æ•°æ®æ¨¡å‹åŠå…³è”åˆ†ç±»ã€ç‰©æµ        | è®¾è®¡å®Œæˆ | Mongoose æ¨¡å‹å’Œ GraphQL Schema å·²è®¾è®¡    |
| 8    | ç‰©æµä¿¡æ¯     | å•†å“ç‰©æµä¿¡æ¯å†…åµŒåŠç®¡ç†              | è®¾è®¡å®Œæˆ | æ”¯æŒçŠ¶æ€è·Ÿè¸ªå’Œé¢„è®¡é€è¾¾æ—¶é—´               |
| 9    | åˆ†ç±»ç®¡ç†     | å•†å“åˆ†ç±»æ¨¡å‹ä¸æ¥å£                  | è®¾è®¡å®Œæˆ | æ”¯æŒå¤šåˆ†ç±»å…³è”                           |

# çŠ¶æ€ç 

| å¸¸é‡å           | å€¼    | è¯´æ˜           | å…¸å‹ä½¿ç”¨åœºæ™¯                                  |
| ---------------- | ----- | -------------- | --------------------------------------------- |
| `OK`             | `200` | æˆåŠŸ           | ç™»å½•æˆåŠŸã€éªŒè¯ç å‘é€æˆåŠŸç­‰                    |
| `BAD_REQUEST`    | `400` | å®¢æˆ·ç«¯è¯·æ±‚æ— æ•ˆ | ç¼ºå°‘å‚æ•°ã€å‚æ•°æ ¼å¼é”™è¯¯                        |
| `UNAUTHORIZED`   | `401` | æœªæˆæƒè®¿é—®     | æœªç™»å½•æˆ– Token æ— æ•ˆ/è¿‡æœŸ                      |
| `FORBIDDEN`      | `403` | è¢«ç¦æ­¢         | æœ‰ç™»å½•ä½†æƒé™ä¸è¶³ï¼Œæ¯”å¦‚æ™®é€šç”¨æˆ·è®¿é—® admin åŠŸèƒ½ |
| `NOT_FOUND`      | `404` | è¯·æ±‚èµ„æºä¸å­˜åœ¨ | æ‰‹æœºå·æŸ¥ä¸åˆ°å¯¹åº”ç”¨æˆ·ã€éªŒè¯ç ä¸å­˜åœ¨ç­‰          |
| `CONFLICT`       | `409` | å†²çª           | æ³¨å†Œæ—¶æ‰‹æœºå·å·²å­˜åœ¨ï¼Œé‡å¤æ“ä½œç­‰                |
| `INTERNAL_ERROR` | `500` | æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ | å¼‚å¸¸æœªæ•è·ã€æ•°æ®åº“è¿æ¥å¤±è´¥ç­‰                  |

# auth.js

æ˜ç™½äº†ï¼è¿™æ˜¯åŸºäºä½ ä¹‹å‰çš„ç™»å½•å’ŒéªŒè¯ç åŠŸèƒ½ï¼Œå¸®ä½ æ•´ç†çš„**æ¥å£æ–‡æ¡£**ï¼Œæ–¹ä¾¿åç»­å¼€å‘å’Œå‰ç«¯è°ƒç”¨ã€‚

---

# çŠ¶æ€ç è¯´æ˜ï¼ˆç¤ºä¾‹ï¼‰

| çŠ¶æ€ç  | å«ä¹‰                     |
| ------ | ------------------------ |
| 200    | è¯·æ±‚æˆåŠŸ                 |
| 400    | è¯·æ±‚å‚æ•°é”™è¯¯             |
| 401    | æœªæˆæƒï¼ˆç™»å½•å¤±è´¥ç­‰ï¼‰     |
| 403    | ç¦æ­¢è®¿é—®                 |
| 404    | èµ„æºæœªæ‰¾åˆ°               |
| 409    | å†²çªï¼ˆå¦‚æ‰‹æœºå·å·²æ³¨å†Œç­‰ï¼‰ |
| 500    | æœåŠ¡å™¨å†…éƒ¨é”™è¯¯           |
| 1001   | éªŒè¯ç è¿‡æœŸ               |
| 1002   | éªŒè¯ç å·²ä½¿ç”¨             |

# å…¬å…±å“åº”ç»“æ„è¯´æ˜

æ‰€æœ‰æ¥å£è¿”å›ç»Ÿä¸€ç»“æ„å¦‚ä¸‹ï¼š

| å­—æ®µå     | ç±»å‹    | è¯´æ˜                       |
| ---------- | ------- | -------------------------- |
| success    | Boolean | è¯·æ±‚æ˜¯å¦æˆåŠŸ               |
| statusCode | Int     | çŠ¶æ€ç ï¼ˆå‚è€ƒåç«¯å®šä¹‰ï¼‰     |
| message    | String  | æ¥å£æç¤ºä¿¡æ¯               |
| data       | Mixed   | å®é™…è¿”å›æ•°æ®ï¼ˆç»“æ„è§ä¸Šæ–‡ï¼‰ |

# æ¥å£æ–‡æ¡£ â€” ç”¨æˆ·ç™»å½• & éªŒè¯ç æ¨¡å—

## 1. å‘é€éªŒè¯ç æ¥å£

### è¯·æ±‚ç±»å‹

```graphql
mutation sendCode($phone: String!) {
  sendCode(phone: $phone) {
    success # Booleanï¼Œæ˜¯å¦æˆåŠŸå‘é€
    statusCode # Intï¼ŒçŠ¶æ€ç ï¼ˆå‚è€ƒå¸¸é‡å®šä¹‰ï¼‰
    message # Stringï¼Œæç¤ºä¿¡æ¯
    code # Stringï¼Œå¼€å‘ç¯å¢ƒä¸‹è¿”å›çš„éªŒè¯ç ï¼Œæ­£å¼ç¯å¢ƒè¿”å› null
  }
}
```

### å‚æ•°è¯´æ˜

| å‚æ•°å | ç±»å‹   | å¿…å¡« | è¯´æ˜       |
| ------ | ------ | ---- | ---------- |
| phone  | String | æ˜¯   | ç”¨æˆ·æ‰‹æœºå· |

### è¿”å›ç¤ºä¾‹

```json
{
  "data": {
    "sendCode": {
      "success": true,
      "statusCode": 200,
      "message": "éªŒè¯ç å‘é€æˆåŠŸ",
      "code": "6752" // ä»…å¼€å‘ç¯å¢ƒè¿”å›
    }
  }
}
```

## 2. éªŒè¯ç ç™»å½•æ¥å£

### è¯·æ±‚ç±»å‹

```graphql
mutation loginWithCode($phone: String!, $code: String!) {
  loginWithCode(phone: $phone, code: $code) {
    success # Booleanï¼Œæ˜¯å¦ç™»å½•æˆåŠŸ
    statusCode # Intï¼ŒçŠ¶æ€ç 
    message # Stringï¼Œæç¤ºä¿¡æ¯
    data {
      # ç™»å½•æˆåŠŸæ—¶è¿”å›çš„æ•°æ®
      token # Stringï¼ŒJWT ä»¤ç‰Œ
      user {
        # ç”¨æˆ·ä¿¡æ¯
        id
        nickname
        phone
        avatar
        role
        status
        createdAt
        updatedAt
      }
    }
  }
}
```

### å‚æ•°è¯´æ˜

| å‚æ•°å | ç±»å‹   | å¿…å¡« | è¯´æ˜             |
| ------ | ------ | ---- | ---------------- |
| phone  | String | æ˜¯   | ç”¨æˆ·æ‰‹æœºå·       |
| code   | String | æ˜¯   | ç”¨æˆ·æ”¶åˆ°çš„éªŒè¯ç  |

### è¿”å›ç¤ºä¾‹

- **ç™»å½•æˆåŠŸ**

```json
{
  "data": {
    "loginWithCode": {
      "success": true,
      "statusCode": 200,
      "message": "ç™»å½•æˆåŠŸ",
      "data": {
        "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
        "user": {
          "id": "60f7c3bd4a3c2b0012345678",
          "nickname": "",
          "phone": "1234567890",
          "avatar": "",
          "role": "client",
          "status": "active",
          "createdAt": "2024-06-23T09:00:00Z",
          "updatedAt": "2024-06-23T10:00:00Z"
        }
      }
    }
  }
}
```

- **ç™»å½•å¤±è´¥ï¼ˆéªŒè¯ç é”™è¯¯æˆ–è¿‡æœŸï¼‰**

```json
{
  "data": {
    "loginWithCode": {
      "success": false,
      "statusCode": 400,
      "message": "éªŒè¯ç é”™è¯¯æˆ–å·²è¿‡æœŸ",
      "data": null
    }
  }
}
```

- **æœåŠ¡å™¨é”™è¯¯**

```json
{
  "data": {
    "loginWithCode": {
      "success": false,
      "statusCode": 500,
      "message": "æœåŠ¡å™¨é”™è¯¯",
      "data": null
    }
  }
}
```

---

## 4. å¤‡æ³¨

- å¼€å‘ç¯å¢ƒä¸‹ `sendCode` æ¥å£ä¼šè¿”å›éªŒè¯ç ï¼Œæ–¹ä¾¿è°ƒè¯•ã€‚æ­£å¼ç¯å¢ƒè¿”å› `code: null`ã€‚
- `loginWithCode` è¿”å›çš„ `token` æ˜¯ JWT ä»¤ç‰Œï¼Œç”¨äºåç»­æ¥å£é‰´æƒã€‚
- ç”¨æˆ·ä¿¡æ¯ä¸­çš„ `id` æ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œç¡®ä¿å‰ç«¯ä½¿ç”¨æ—¶æ­£ç¡®è§£æã€‚
- æ‰€æœ‰æ¥å£å‡è¿”å›ç»Ÿä¸€ç»“æ„ `{ success, statusCode, message, data }`ï¼Œæ–¹ä¾¿ç»Ÿä¸€å¤„ç†ã€‚

# æ¥å£æ–‡æ¡£ â€” åˆ†ç±»ç®¡ç†æ¨¡å—ï¼ˆCategoryï¼‰

## 1. æŸ¥è¯¢åˆ†ç±»åˆ—è¡¨

### è¯·æ±‚ç±»å‹

```graphql
query categories($input: CategoriesInput) {
  categories(input: $input) {
    success
    statusCode
    message
    data {
      items {
        id
        name
        description
        parent {
          id
          name
        }
        order
        visible
      }
      total
      page
      pageSize
    }
  }
}
```

### å‚æ•°è¯´æ˜

| å‚æ•°å          | ç±»å‹    | å¿…å¡« | é»˜è®¤å€¼ | è¯´æ˜               |
| --------------- | ------- | ---- | ------ | ------------------ |
| showOnlyVisible | Boolean | å¦   | false  | æ˜¯å¦ä»…æ˜¾ç¤ºå¯è§åˆ†ç±» |
| page            | Int     | å¦   | 1      | å½“å‰é¡µç            |
| pageSize        | Int     | å¦   | 20     | æ¯é¡µæ•°é‡           |

---

## 2. æŸ¥è¯¢å•ä¸ªåˆ†ç±»è¯¦æƒ…

### è¯·æ±‚ç±»å‹

```graphql
query category($id: ID!) {
  category(id: $id) {
    success
    statusCode
    message
    data {
      id
      name
      description
      parent {
        id
        name
      }
      order
      visible
    }
  }
}
```

### å‚æ•°è¯´æ˜

| å‚æ•°å | ç±»å‹ | å¿…å¡« | è¯´æ˜           |
| ------ | ---- | ---- | -------------- |
| id     | ID   | æ˜¯   | åˆ†ç±»çš„å”¯ä¸€æ ‡è¯† |

---

## 3. åˆ›å»ºåˆ†ç±»

### è¯·æ±‚ç±»å‹

```graphql
mutation createCategory($input: CreateCategoryInput!) {
  createCategory(input: $input) {
    success
    statusCode
    message
    data {
      id
      name
      description
      parent {
        id
        name
      }
      order
      visible
    }
  }
}
```

### å‚æ•°è¯´æ˜

| å‚æ•°å      | ç±»å‹   | å¿…å¡« | è¯´æ˜                  |
| ----------- | ------ | ---- | --------------------- |
| name        | String | æ˜¯   | åˆ†ç±»åç§°ï¼ˆå”¯ä¸€ï¼‰      |
| description | String | å¦   | åˆ†ç±»æè¿°              |
| parentId    | ID     | å¦   | çˆ¶çº§åˆ†ç±» ID           |
| order       | Int    | å¦   | æ’åºå€¼ï¼Œè¶Šå°è¶Šé å‰    |
| visible     | Bool   | å¦   | æ˜¯å¦æ˜¾ç¤ºï¼ˆé»˜è®¤ trueï¼‰ |

---

## 4. ä¿®æ”¹åˆ†ç±»

### è¯·æ±‚ç±»å‹

```graphql
mutation updateCategory($input: UpdateCategoryInput!) {
  updateCategory(input: $input) {
    success
    statusCode
    message
    data {
      id
      name
      description
      parent {
        id
        name
      }
      order
      visible
    }
  }
}
```

### å‚æ•°è¯´æ˜

| å‚æ•°å      | ç±»å‹   | å¿…å¡« | è¯´æ˜                |
| ----------- | ------ | ---- | ------------------- |
| id          | ID     | æ˜¯   | è¦ä¿®æ”¹çš„åˆ†ç±» ID     |
| name        | String | å¦   | åˆ†ç±»åç§°ï¼ˆå¯é€‰ï¼‰    |
| description | String | å¦   | åˆ†ç±»æè¿°            |
| parentId    | ID     | å¦   | çˆ¶çº§åˆ†ç±» IDï¼ˆå¯é€‰ï¼‰ |
| order       | Int    | å¦   | æ’åºå€¼              |
| visible     | Bool   | å¦   | æ˜¯å¦æ˜¾ç¤º            |

---

## 5. åˆ é™¤åˆ†ç±»

### è¯·æ±‚ç±»å‹

```graphql
mutation deleteCategory($id: ID!) {
  deleteCategory(id: $id) {
    success
    statusCode
    message
    data # Booleanï¼Œæ˜¯å¦åˆ é™¤æˆåŠŸ
  }
}
```

### ç‰¹åˆ«è¯´æ˜

- åˆ é™¤åˆ†ç±»æ—¶ï¼Œå¦‚æœå­˜åœ¨å­åˆ†ç±»ï¼Œä¼šå°†å…¶ `parent` è®¾ç½®ä¸º `null`ï¼Œå¹¶ **ä¸ä¼šçº§è”åˆ é™¤å­åˆ†ç±»**ã€‚

---

## 6. æŸ¥è¯¢åˆ†ç±»æ ‘ç»“æ„

### è¯·æ±‚ç±»å‹

```graphql
query categoryTree {
  categoryTree {
    success
    statusCode
    message
    data {
      id
      name
      description
      order
      visible
      children {
        id
        name
        children {
          id
          name
        }
      }
    }
  }
}
```

### è¿”å›è¯´æ˜

- è¿”å›å®Œæ•´çš„åˆ†ç±»æ ‘ç»“æ„ï¼ŒåµŒå¥—å½¢å¼ç»„ç»‡ï¼ˆæ— é™å±‚çº§æ”¯æŒï¼‰ã€‚
- æ¯ä¸ªèŠ‚ç‚¹çš„ `children` å­—æ®µä¸ºè¯¥åˆ†ç±»ä¸‹çš„å­åˆ†ç±»æ•°ç»„ã€‚

---

## ğŸ§± æ¥å£ç»Ÿä¸€è¿”å›ç»“æ„

æ‰€æœ‰æ¥å£è¿”å›ç»“æ„å¦‚ä¸‹ï¼š

```ts
type Result<T = any> {
  success: boolean
  statusCode: number
  message: string
  data: T
}
```

---

## ğŸ“ é™„åŠ è¯´æ˜

- æ‰€æœ‰åˆ†ç±» ID å‡ä¸ºå­—ç¬¦ä¸²ï¼Œå‰ç«¯éœ€æ­£ç¡®å¤„ç†ã€‚
- æŸ¥è¯¢æ¥å£ç»Ÿä¸€æ”¯æŒ `populate` è·å–çˆ¶åˆ†ç±»ä¿¡æ¯ã€‚
- `toJSON` è‡ªåŠ¨å°† `_id` è½¬æ¢ä¸º `id` å­—æ®µã€‚
- åˆ é™¤ã€æ›´æ–°ã€åˆ›å»ºæ“ä½œå‡åšäº†é”™è¯¯å¤„ç†ä¸æç¤ºä¿¡æ¯è¿”å›ã€‚
- å¦‚æœéœ€è¦ä½¿ç”¨åˆ†é¡µæŸ¥è¯¢ï¼Œè¯·ä¼ å…¥ `page` å’Œ `pageSize`ï¼Œå¦åˆ™è¿”å›å…¨éƒ¨æ•°æ®ã€‚
